<!DOCTYPE html>
<html lang="es">
    <head>
        <title>Wallet - Transferir Dinero</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
        <link rel="icon" href="./favicon.ico" type="image/x-icon">
        <style>
            body {
                padding: 20px;
            }
            .container {
                max-width: 400px;
                margin: auto;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="card shadow p-4">
                <h2 class="text-center mb-4">Enviar Dinero</h2>

                <button class="btn btn-primary btn-block mb-3" id="addContactBtn">
                Agregar nuevo contacto
                </button>

                <h5>Contactos</h5>
                <ul class="list-group mb-3" id="contactList"></ul>

                <div class="form-group mt-3">
                <label for="amount">Monto a enviar</label>
                    <input
                        type="number"
                        id="amount"
                        class="form-control"
                        placeholder="Ingrese el monto"
                    >
                </div>


                <button class="btn btn-success btn-block" id="sendMoneyBtn" style="display:none;">
                  Enviar dinero
                </button>

                <div id="alert-container" class="mt-3"></div>

                <a href="menu.html" class="btn btn-link text-center mt-3">
                Volver al menú principal
                </a>
            </div>
        </div>

        <!-- MODAL -->
        <div class="modal fade" id="contactModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content p-3">
                    <h5>Nuevo Contacto</h5>

                    <input type="text" id="contactName" class="form-control mb-2" placeholder="Nombre y apellido">
                    <input type="text" id="contactAccount" class="form-control mb-2" placeholder="N° cta (8 dígitos)">
                    <input type="text" id="contactBank" class="form-control mb-3" placeholder="Nombre del banco">

                    <button class="btn btn-primary btn-block" id="saveContactBtn">
                        Guardar contacto
                    </button>
                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
        <script>
        $(document).ready(function () {
        
          // Protección de sesión
          if (!localStorage.getItem("logged")) {
            window.location.href = "index.html";
          }
        
          let contacts = JSON.parse(localStorage.getItem("contacts")) || [];
        
          // Renderizar contactos
          function renderContacts() {
            $('#contactList').html('');
            contacts.forEach((c, index) => {
              $('#contactList').append(`
                <li class="list-group-item">
                  <input type="radio" name="contact" value="${index}">
                  <strong>${c.name}</strong><br>
                  N° cta: ${c.account} - ${c.bank}
                </li>
              `);
            });
          }
        
          renderContacts();
        
          // Abrir modal
          $('#addContactBtn').click(function () {
            $('#contactModal').modal('show');
          });
        
          // Guardar contacto
          $('#saveContactBtn').click(function () {
            const name = $('#contactName').val().trim();
            const account = $('#contactAccount').val().trim();
            const bank = $('#contactBank').val().trim();
        
            $('#alert-container').html('');
        
            if (!name || !account || !bank) {
              $('#alert-container').html(`
                <div class="alert alert-danger">
                  Completa todos los campos
                </div>
              `);
              return;
            }
        
            if (!/^\d{8}$/.test(account)) {
              $('#alert-container').html(`
                <div class="alert alert-danger">
                  El número de cuenta debe tener 8 dígitos
                </div>
              `);
              return;
            }
        
            contacts.push({ name, account, bank });
            localStorage.setItem("contacts", JSON.stringify(contacts));
        
            $('#contactModal').modal('hide');
            $('#contactName, #contactAccount, #contactBank').val('');
            renderContacts();
          });
        
          // Mostrar botón al seleccionar contacto
          $(document).on('change', 'input[name="contact"]', function () {
            $('#sendMoneyBtn').fadeIn();
            $(this).closest('li').addClass('active')
              .siblings().removeClass('active');
          });
        
          // Enviar dinero
          $('#sendMoneyBtn').click(function () {
            const selected = $('input[name="contact"]:checked');
        
            if (!selected.length) {
              $('#alert-container').html(`
                <div class="alert alert-danger">
                  Seleccione un contacto
                </div>
              `);
              return;
            }
        
            const amount = Number($('#amount').val());
            if (amount <= 0 || isNaN(amount)) {
              $('#alert-container').html(`
                <div class="alert alert-danger">
                  Ingrese un monto válido
                </div>
              `);
              return;
            }
        
            let balance = Number(localStorage.getItem("balance")) || 0;
            if (balance < amount) {
              $('#alert-container').html(`
                <div class="alert alert-danger">
                  Saldo insuficiente
                </div>
              `);
              return;
            }
        
            balance -= amount;
            localStorage.setItem("balance", balance);
        
            const transactions = JSON.parse(localStorage.getItem("transactions")) || [];
            const contact = contacts[selected.val()];
            transactions.push(`Transferencia a ${contact.name} - $${amount}`);
            localStorage.setItem("transactions", JSON.stringify(transactions));
        
            $('#alert-container').html(`
              <div class="alert alert-success">
                Transferencia realizada con éxito
              </div>
            `);
        
            setTimeout(function () {
              window.location.href = "menu.html";
            }, 1000);
          });
        
        });
        </script>
    </body>
</html>


